$(document).ready(function () {

    // Find all tables inside #fact-sheet
    $('#fact-sheet table').not('.ingredients').each(function (index, table) {
        // Create the Download as CSV link
        var $link = $('<a href="#" class="download-csv">Download this table as a CSV file</a>');

        // Insert the link after the table
        $(table).after($link);

        // Click handler for CSV download
        $link.on('click', function (e) {
            e.preventDefault(); // Prevent default link navigation
            var csv = [];
            $(table).find('tr').each(function () {
                var row = [];
                $(this).find('th,td').each(function () {
                    // Get cell HTML, replace <br> with space, decode HTML entities, trim whitespace
                    var html = $(this).html()
                        .replace(/<br\s*\/?>/gi, ' ')
                        .replace(/&nbsp;/gi, ' ');
                    var text = $('<div>').html(html).text().replace(/"/g, '""').trim();
                    row.push('"' + text + '"');
                });
                csv.push(row.join(','));
            });
            var csvContent = '\uFEFF' + csv.join('\r\n');
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);

            var factSheetName = $(".fsTitle").text();
            var tableName = $(table).find("caption").text();
            var csvName = "NIH ODS Factsheet " + factSheetName + " - " + tableName.replace(/\[.*?\]+/g, "");
            csvName = csvName.substring(0, 100);

            // Set link attributes and trigger download
            var downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = csvName + ".csv";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
        });
    });
}); // end document.ready